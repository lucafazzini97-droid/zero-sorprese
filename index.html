<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Zero Sorprese - Cruscotto Fiscale</title>
    
    <!-- 1. Stile Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- 2. React & ReactDOM (Core) -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    
    <!-- 3. Prop-Types (Dipendenza necessaria per Recharts UMD) -->
    <script src="https://unpkg.com/prop-types/prop-types.min.js"></script>

    <!-- 4. Recharts (Grafici) - Versione Fissata Stabile -->
    <script src="https://unpkg.com/recharts@2.12.0/umd/Recharts.js"></script>
    
    <!-- 5. Lucide (Icone) - Versione Fissata Stabile e Percorso UMD Corretto -->
    <script src="https://unpkg.com/lucide@0.263.1/dist/umd/lucide.min.js"></script>
    
    <!-- 6. Babel (Compilatore JSX) -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <!-- Font e Configurazioni Custom -->
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;900&display=swap');
        body { font-family: 'Inter', sans-serif; }
        /* Nascondi scrollbar brutte */
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
    </style>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: { sans: ['Inter', 'sans-serif'] },
                    colors: {
                        slate: { 850: '#1e293b', 950: '#020617' } // Estensioni dark
                    }
                }
            }
        }
    </script>
</head>
<body class="bg-[#F8F9FC] text-slate-900 antialiased selection:bg-slate-900 selection:text-white">

    <!-- Root dell'applicazione React -->
    <div id="root"></div>

    <!-- CODICE APPLICAZIONE -->
    <script type="text/babel">
        const { useState, useMemo, useEffect } = React;
        
        // Verifica caricamento Recharts
        if (!window.Recharts) {
            console.error("Recharts non caricato correttamente.");
        }

        // Destrutturazione librerie globali
        const { 
            PieChart, Pie, Cell, BarChart, Bar, XAxis, YAxis, CartesianGrid, Tooltip: RechartsTooltip, ResponsiveContainer, Legend 
        } = window.Recharts;

        // --- HELPER FORMATTAZIONE VALUTA ---
        const formatMoney = (amount) => {
            return amount.toLocaleString('it-IT', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
        };

        // --- ADAPTER ICONE LUCIDE (CORRETTO E ROBUSTO) ---
        const Icon = ({ name, size = 24, className, ...props }) => {
            if (!window.lucide || !window.lucide.icons) return null;
            const iconData = window.lucide.icons[name];
            if (!iconData) return null;
            
            const [tag, attrs, children] = iconData;
            const safeChildren = Array.isArray(children) ? children : [];

            return React.createElement('svg', {
                ...attrs,
                width: size,
                height: size,
                className: className,
                ...props,
                dangerouslySetInnerHTML: {
                    __html: safeChildren.map(child => {
                        if (!Array.isArray(child)) return '';
                        const [childTag, childAttrs] = child;
                        const attrString = Object.entries(childAttrs || {}).map(([k, v]) => `${k}="${v}"`).join(' ');
                        return `<${childTag} ${attrString} />`;
                    }).join('')
                }
            });
        };

        const Icons = {
            LayoutDashboard: (p) => <Icon name="LayoutDashboard" {...p} />,
            TrendingUp: (p) => <Icon name="TrendingUp" {...p} />,
            TrendingDown: (p) => <Icon name="TrendingDown" {...p} />,
            Calculator: (p) => <Icon name="Calculator" {...p} />,
            Settings: (p) => <Icon name="Settings" {...p} />,
            Plus: (p) => <Icon name="Plus" {...p} />,
            Trash2: (p) => <Icon name="Trash2" {...p} />,
            AlertCircle: (p) => <Icon name="AlertCircle" {...p} />,
            Building2: (p) => <Icon name="Building2" {...p} />,
            Calendar: (p) => <Icon name="Calendar" {...p} />,
            Download: (p) => <Icon name="Download" {...p} />,
            ScanLine: (p) => <Icon name="ScanLine" {...p} />,
            FileUp: (p) => <Icon name="FileUp" {...p} />,
            Briefcase: (p) => <Icon name="Briefcase" {...p} />,
            ChevronRight: (p) => <Icon name="ChevronRight" {...p} />,
        };

        // --- LOGO COMPONENT ---
        const Logo = () => (
            <div className="flex flex-col select-none">
                <div className="font-black text-2xl tracking-tighter text-slate-900 flex items-center gap-1 leading-none">
                <span>ZERO</span>
                <span className="font-light">SORPRESE</span>
                </div>
                <div className="text-[10px] font-medium tracking-widest text-slate-400 uppercase mt-1 flex items-center gap-1">
                <span className="w-2 h-[1px] bg-slate-400"></span>
                BU of REFISA
                </div>
            </div>
        );

        // --- DATI DI ESEMPIO ---
        const INITIAL_TRANSACTIONS = [
            { id: 1, type: 'income', date: '2024-01-15', description: 'Consulenza Sviluppo Web', amount: 2500, paid: true },
            { id: 2, type: 'income', date: '2024-02-10', description: 'Progetto E-commerce', amount: 4000, paid: true },
            { id: 3, type: 'expense', date: '2024-01-20', description: 'Abbonamento Software', amount: 120.50, deductibility: 100, category: 'Software' },
            { id: 4, type: 'expense', date: '2024-03-05', description: 'Cena aziendale', amount: 80.20, deductibility: 50, category: 'Rappresentanza' },
        ];

        const INITIAL_SETTINGS = {
            regime: 'forfettario', 
            coefficienteRedditivita: 78,
            impostaSostitutiva: 15,
            aliquotaInps: 26.23,
            scaglioniIrpef: [
                { limit: 28000, rate: 23 },
                { limit: 50000, rate: 35 },
                { limit: Infinity, rate: 43 }
            ]
        };

        // --- COMPONENTI UI BASE ---
        const Card = ({ children, className = '', noPadding = false }) => (
            <div className={`bg-white rounded-2xl shadow-[0_2px_10px_-3px_rgba(6,81,237,0.1)] border border-slate-100 ${noPadding ? '' : 'p-6'} ${className}`}>
                {children}
            </div>
        );

        const Badge = ({ children, color = 'slate' }) => {
            const colors = {
                slate: 'bg-slate-100 text-slate-700',
                green: 'bg-emerald-50 text-emerald-700 border border-emerald-100',
                red: 'bg-rose-50 text-rose-700 border border-rose-100',
                yellow: 'bg-amber-50 text-amber-700 border border-amber-100',
                black: 'bg-slate-900 text-white'
            };
            return (
                <span className={`px-3 py-1 rounded-full text-xs font-semibold ${colors[color] || colors.slate}`}>
                {children}
                </span>
            );
        };

        const Button = ({ children, onClick, variant = 'primary', icon, className = '', disabled = false }) => {
            const baseStyle = "flex items-center justify-center gap-2 px-5 py-2.5 rounded-xl font-medium transition-all duration-200 disabled:opacity-50 disabled:cursor-not-allowed active:scale-95";
            const variants = {
                primary: "bg-slate-900 text-white hover:bg-slate-800 shadow-lg shadow-slate-900/20",
                secondary: "bg-white text-slate-700 border border-slate-200 hover:bg-slate-50 hover:border-slate-300",
                danger: "bg-white text-rose-600 hover:bg-rose-50 border border-rose-100",
                ghost: "text-slate-500 hover:text-slate-900 hover:bg-slate-100",
                success: "bg-emerald-600 text-white hover:bg-emerald-700 shadow-lg shadow-emerald-600/20"
            };
            const IconComp = icon;
            return (
                <button onClick={onClick} disabled={disabled} className={`${baseStyle} ${variants[variant]} ${className}`}>
                {IconComp && <IconComp size={18} />}
                {children}
                </button>
            );
        };

        const ProgressBar = ({ value, max, label }) => {
            const percentage = Math.min(100, Math.max(0, (value / max) * 100));
            let color = 'bg-slate-800';
            if (percentage > 75) color = 'bg-amber-500';
            if (percentage > 90) color = 'bg-rose-500';

            return (
                <div className="w-full">
                <div className="flex justify-between text-xs mb-2">
                    <span className="font-medium text-slate-500">{label}</span>
                    <span className={`font-bold ${percentage > 90 ? 'text-rose-600' : 'text-slate-700'}`}>
                    {formatMoney(value)} / {formatMoney(max)} €
                    </span>
                </div>
                <div className="h-3 w-full bg-slate-100 rounded-full overflow-hidden">
                    <div 
                    className={`h-full ${color} transition-all duration-1000 ease-out rounded-full`} 
                    style={{ width: `${percentage}%` }}
                    />
                </div>
                </div>
            );
        };

        // --- HOOK LOGICA ---
        const useTaxCalculator = (transactions, settings, simulatedRevenueAdd = 0) => {
            return useMemo(() => {
                const incomes = transactions.filter(t => t.type === 'income');
                const expenses = transactions.filter(t => t.type === 'expense');

                const totalRevenue = incomes.reduce((acc, curr) => acc + curr.amount, 0) + simulatedRevenueAdd;
                const totalExpensesReal = expenses.reduce((acc, curr) => acc + curr.amount, 0);
                
                let taxableIncome = 0;
                let taxes = 0;
                let inps = 0;
                let totalDeductibleExpenses = 0;

                if (settings.regime === 'forfettario') {
                taxableIncome = totalRevenue * (settings.coefficienteRedditivita / 100);
                inps = taxableIncome * (settings.aliquotaInps / 100);
                const imponibileNettoInps = taxableIncome - inps; 
                taxes = imponibileNettoInps * (settings.impostaSostitutiva / 100);
                } else {
                totalDeductibleExpenses = expenses.reduce((acc, curr) => {
                    const deducibility = curr.deductibility || 0;
                    return acc + (curr.amount * (deducibility / 100));
                }, 0);
                taxableIncome = Math.max(0, totalRevenue - totalDeductibleExpenses);
                inps = taxableIncome * (settings.aliquotaInps / 100);
                const incomeAfterInps = Math.max(0, taxableIncome - inps);

                let remainingIncome = incomeAfterInps;
                let calculatedIrpef = 0;
                let previousLimit = 0;

                for (let bracket of settings.scaglioniIrpef) {
                    if (remainingIncome <= 0) break;
                    const taxableInThisBracket = Math.min(remainingIncome, bracket.limit - previousLimit);
                    calculatedIrpef += taxableInThisBracket * (bracket.rate / 100);
                    remainingIncome -= taxableInThisBracket;
                    previousLimit = bracket.limit;
                }
                taxes = calculatedIrpef;
                }

                const totalTaxLoad = taxes + inps;
                const netIncome = totalRevenue - totalExpensesReal - totalTaxLoad;

                return {
                totalRevenue,
                totalExpensesReal,
                totalDeductibleExpenses,
                taxableIncome,
                inps,
                taxes,
                totalTaxLoad,
                netIncome
                };
            }, [transactions, settings, simulatedRevenueAdd]);
        };

        // --- COMPONENTI AVANZATI ---
        const SmartAlert = ({ revenue, limit = 85000, regime }) => {
            if (regime !== 'forfettario') return null;
            const remaining = limit - revenue;
            const isCritical = remaining < 5000;

            return (
                <Card className={`border-l-[6px] ${isCritical ? 'border-l-rose-500 bg-rose-50/50' : 'border-l-slate-800'}`}>
                <div className="flex items-start gap-4">
                    <div className={`p-3 rounded-xl ${isCritical ? 'bg-rose-100 text-rose-600' : 'bg-slate-100 text-slate-800'}`}>
                    <Icons.AlertCircle size={24} />
                    </div>
                    <div className="flex-1">
                    <h4 className="font-bold text-slate-900 mb-2 text-sm">
                        {isCritical ? 'Soglia Critica Raggiunta' : 'Monitoraggio Forfettario'}
                    </h4>
                    <ProgressBar value={revenue} max={limit} label="Plafond Ricavi 85k" />
                    </div>
                </div>
                </Card>
            );
        };

        const TaxTimeline = ({ taxes, inps }) => {
            const totalDue = taxes + inps;
            const accontoGiugno = totalDue * 0.5; 
            const accontoNovembre = totalDue * 0.5;

            const deadlines = [
                { date: '30 Giu', fullDate: '30 Giugno', label: 'Saldo + 1° Acconto', amount: accontoGiugno },
                { date: '30 Nov', fullDate: '30 Novembre', label: '2° Acconto', amount: accontoNovembre },
            ];

            return (
                <Card>
                <div className="flex justify-between items-center mb-6">
                    <h4 className="font-bold text-slate-800 flex items-center gap-2">
                    <Icons.Calendar className="text-slate-400" size={20} /> Timeline Fiscale
                    </h4>
                    <span className="text-[10px] uppercase font-bold tracking-wider text-slate-400">Previsione</span>
                </div>
                
                <div className="relative space-y-6 pl-4 border-l border-dashed border-slate-200 ml-2">
                    {deadlines.map((item, idx) => (
                    <div key={idx} className="relative pl-6">
                        <div className="absolute -left-[21px] top-1 w-3 h-3 rounded-full bg-white border-2 border-slate-900 ring-4 ring-slate-50"></div>
                        <div className="flex flex-col sm:flex-row sm:items-center justify-between gap-2 bg-slate-50/50 p-3 rounded-lg hover:bg-slate-50 transition-colors">
                            <div>
                            <div className="text-xs font-bold text-slate-400 uppercase">{item.fullDate}</div>
                            <div className="font-semibold text-slate-900">{item.label}</div>
                            </div>
                            <div className="text-right">
                            <div className="font-bold text-slate-900">€ {formatMoney(item.amount)}</div>
                            <div className="text-[10px] text-amber-600 font-medium bg-amber-50 px-2 py-0.5 rounded-full inline-block">Da accantonare</div>
                            </div>
                        </div>
                    </div>
                    ))}
                </div>
                </Card>
            );
        };

        // --- PAGINE ---
        const Dashboard = ({ data, settings }) => {
            const [isGeneratingReport, setIsGeneratingReport] = useState(false);

            const handleDownloadReport = () => {
                setIsGeneratingReport(true);
                setTimeout(() => {
                // Sostituito alert() con la chiamata al browser 'confirm' per rimanere compliant
                if (confirm("Report PDF generato con successo! Vuoi scaricarlo?")) {
                    console.log("Download avviato.");
                }
                setIsGeneratingReport(false);
                }, 2000);
            };

            const chartData = [
                { name: 'Netto', value: data.netIncome, color: '#10B981' }, 
                { name: 'Tasse', value: data.taxes, color: '#F43F5E' }, 
                { name: 'INPS', value: data.inps, color: '#F59E0B' }, 
                { name: 'Spese', value: data.totalExpensesReal, color: '#94A3B8' } 
            ];

            return (
                <div className="space-y-6 animate-in fade-in duration-500">
                <SmartAlert revenue={data.totalRevenue} regime={settings.regime} />

                <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
                    <Card>
                    <p className="text-slate-500 text-xs font-bold uppercase tracking-wider mb-1">Fatturato</p>
                    <h3 className="text-2xl font-bold text-slate-900">€ {formatMoney(data.totalRevenue)}</h3>
                    <div className="mt-2 text-xs text-emerald-600 bg-emerald-50 inline-flex items-center px-2 py-0.5 rounded">
                        <Icons.TrendingUp size={12} className="mr-1" /> Incassato
                    </div>
                    </Card>

                    <Card>
                    <p className="text-slate-500 text-xs font-bold uppercase tracking-wider mb-1">Stima Tasse</p>
                    <h3 className="text-2xl font-bold text-rose-600">€ {formatMoney(data.totalTaxLoad)}</h3>
                    <div className="mt-2 text-xs text-rose-600 bg-rose-50 inline-flex items-center px-2 py-0.5 rounded">
                        <Icons.AlertCircle size={12} className="mr-1" /> Accantona
                    </div>
                    </Card>

                    <Card className="bg-slate-900 text-white border-slate-800 relative overflow-hidden group">
                    <div className="absolute top-0 right-0 p-3 opacity-10 group-hover:opacity-20 transition-opacity">
                        <Icons.Briefcase size={60} />
                    </div>
                    <p className="text-slate-400 text-xs font-bold uppercase tracking-wider mb-1">Disponibile Reale</p>
                    <h3 className="text-2xl font-bold text-white">€ {formatMoney(data.netIncome)}</h3>
                    <div className="mt-2 text-xs text-emerald-400 bg-white/10 inline-flex items-center px-2 py-0.5 rounded border border-white/10">
                        <span className="w-1.5 h-1.5 rounded-full bg-emerald-400 mr-1.5"></span> Safe to spend
                    </div>
                    </Card>

                    <Card className="flex flex-col justify-between">
                    <div>
                        <p className="text-slate-500 text-xs font-bold uppercase tracking-wider">Reportistica</p>
                        <h3 className="text-lg font-bold text-slate-700 mt-1">Report {new Date().getFullYear()}</h3>
                    </div>
                    <Button 
                        onClick={handleDownloadReport} 
                        variant="secondary" 
                        className="w-full mt-2 text-xs py-2" 
                        icon={isGeneratingReport ? null : Icons.Download}
                        disabled={isGeneratingReport}
                    >
                        {isGeneratingReport ? '...' : 'Scarica PDF'}
                    </Button>
                    </Card>
                </div>

                <div className="grid grid-cols-1 lg:grid-cols-3 gap-6">
                    <div className="lg:col-span-2 space-y-6">
                    <Card>
                        <div className="flex justify-between items-center mb-6">
                        <h4 className="font-bold text-slate-800">Analisi Flusso di Cassa</h4>
                        </div>
                        <div className="h-72 w-full">
                        <ResponsiveContainer width="100%" height="100%">
                            <BarChart data={chartData} layout="vertical" margin={{ top: 5, right: 30, left: 40, bottom: 5 }}>
                            <CartesianGrid strokeDasharray="3 3" horizontal={false} stroke="#f1f5f9" />
                            <XAxis type="number" hide />
                            <YAxis dataKey="name" type="category" width={60} tick={{fontSize: 12, fill: '#64748b'}} axisLine={false} tickLine={false} />
                            <RechartsTooltip 
                                cursor={{fill: '#f8fafc'}}
                                contentStyle={{borderRadius: '8px', border: 'none', boxShadow: '0 4px 6px -1px rgb(0 0 0 / 0.1)'}}
                                formatter={(value) => [`€ ${formatMoney(value)}`, 'Importo']} 
                            />
                            <Bar dataKey="value" radius={[0, 6, 6, 0]} barSize={32}>
                                {chartData.map((entry, index) => (
                                <Cell key={`cell-${index}`} fill={entry.color} />
                                ))}
                            </Bar>
                            </BarChart>
                        </ResponsiveContainer>
                        </div>
                    </Card>
                    <TaxTimeline taxes={data.taxes} inps={data.inps} />
                    </div>

                    <div className="space-y-6">
                    <Card>
                        <h4 className="font-bold text-slate-800 mb-4">Peso Fiscale</h4>
                        <div className="h-56 w-full relative">
                        <div className="absolute inset-0 flex items-center justify-center flex-col pointer-events-none">
                            <span className="text-3xl font-bold text-slate-900">{Math.round((data.totalTaxLoad / data.totalRevenue) * 100)}%</span>
                            <span className="text-xs text-slate-400 uppercase">Tax Rate</span>
                        </div>
                        <ResponsiveContainer width="100%" height="100%">
                            <PieChart>
                            <Pie
                                data={[
                                { name: 'Netto', value: data.netIncome },
                                { name: 'INPS', value: data.inps },
                                { name: 'Imposte', value: data.taxes },
                                { name: 'Spese', value: data.totalExpensesReal }
                                ]}
                                cx="50%"
                                cy="50%"
                                innerRadius={65}
                                outerRadius={80}
                                paddingAngle={2}
                                dataKey="value"
                                stroke="none"
                            >
                                <Cell fill="#10B981" />
                                <Cell fill="#F59E0B" />
                                <Cell fill="#F43F5E" />
                                <Cell fill="#94A3B8" />
                            </Pie>
                            <RechartsTooltip />
                            </PieChart>
                        </ResponsiveContainer>
                        </div>
                        <div className="flex flex-wrap justify-center gap-3 mt-4">
                            <div className="flex items-center gap-1 text-xs text-slate-600"><span className="w-2 h-2 rounded-full bg-emerald-500"></span>Netto</div>
                            <div className="flex items-center gap-1 text-xs text-slate-600"><span className="w-2 h-2 rounded-full bg-amber-500"></span>INPS</div>
                            <div className="flex items-center gap-1 text-xs text-slate-600"><span className="w-2 h-2 rounded-full bg-rose-500"></span>Tasse</div>
                        </div>
                    </Card>

                    <Card className="bg-gradient-to-br from-slate-900 to-slate-800 text-white border-none">
                        <div className="flex gap-3">
                        <div className="bg-white/10 p-2.5 rounded-xl h-fit">
                            <Icons.Briefcase size={20} className="text-white" />
                        </div>
                        <div>
                            <h5 className="font-bold text-sm">Il Consiglio di Refisa</h5>
                            <p className="text-xs text-slate-300 mt-1 leading-relaxed">
                            "Hai un margine operativo del 68%. Considera di investire parte del netto in formazione deducibile per abbattere l'imponibile del prossimo anno."
                            </p>
                        </div>
                        </div>
                    </Card>
                    </div>
                </div>
                </div>
            );
        };

        const Transactions = ({ transactions, setTransactions, type }) => {
            const [isAdding, setIsAdding] = useState(false);
            const [isImporting, setIsImporting] = useState(false);
            const [isScanning, setIsScanning] = useState(false);

            const [formData, setFormData] = useState({
                description: '',
                amount: '',
                date: new Date().toISOString().split('T')[0],
                deductibility: 100,
                category: 'Generale'
            });

            const handleImportXML = () => {
                setIsImporting(true);
                setTimeout(() => {
                const newTx = {
                    id: Date.now(),
                    type: 'income',
                    description: 'Fattura XML #0042',
                    amount: Math.floor(Math.random() * 2000) + 500.55, // Aggiungo decimali per demo
                    date: new Date().toISOString().split('T')[0],
                    paid: true,
                    category: 'Consulenza'
                };
                setTransactions(prev => [...prev, newTx]);
                setIsImporting(false);
                // Sostituito alert() con la chiamata al browser 'confirm'
                if (confirm("Fattura XML importata con successo! Vuoi verificare i dati?")) {
                    console.log("Dati verificati.");
                }
                }, 1500);
            };

            const handleOCRScan = () => {
                setIsScanning(true);
                setTimeout(() => {
                setIsAdding(true);
                setFormData({
                    description: 'Ristorante "Da Luigi"',
                    amount: '45.50',
                    date: new Date().toISOString().split('T')[0],
                    deductibility: 50,
                    category: 'Rappresentanza'
                });
                setIsScanning(false);
                }, 1800);
            };

            const handleSubmit = (e) => {
                e.preventDefault();
                const newTx = {
                id: Date.now(),
                type,
                description: formData.description,
                amount: parseFloat(formData.amount),
                date: formData.date,
                deductibility: parseInt(formData.deductibility),
                category: formData.category,
                paid: true
                };
                setTransactions([...transactions, newTx]);
                setIsAdding(false);
                setFormData({ description: '', amount: '', date: new Date().toISOString().split('T')[0], deductibility: 100, category: 'Generale' });
            };

            // FUNZIONE ELIMINAZIONE CORRETTA
            const deleteTx = (id) => {
                if (confirm('Sei sicuro di voler eliminare questa voce? L\'operazione è irreversibile.')) {
                    setTransactions(current => current.filter(t => t.id !== id));
                }
            };

            const filteredTx = transactions.filter(t => t.type === type);

            return (
                <div className="space-y-6 animate-in slide-in-from-bottom-4 duration-500">
                <div className="flex flex-col md:flex-row justify-between items-start md:items-center gap-4">
                    <h2 className="text-xl font-bold text-slate-900">Gestione {type === 'income' ? 'Ricavi' : 'Spese'}</h2>
                    
                    <div className="flex gap-2">
                    {type === 'income' && (
                        <Button onClick={handleImportXML} variant="secondary" icon={isImporting ? null : Icons.FileUp} disabled={isImporting}>
                        {isImporting ? '...' : 'Importa XML'}
                        </Button>
                    )}
                    
                    {type === 'expense' && (
                        <Button onClick={handleOCRScan} variant="secondary" icon={isScanning ? null : Icons.ScanLine} disabled={isScanning}>
                        {isScanning ? 'Scan AI...' : 'Scan Scontrino'}
                        </Button>
                    )}

                    <Button onClick={() => setIsAdding(!isAdding)} icon={isAdding ? null : Icons.Plus}>
                        {isAdding ? 'Chiudi' : 'Aggiungi'}
                    </Button>
                    </div>
                </div>

                {isAdding && (
                    <Card className="bg-slate-50 border-slate-200">
                    <div className="flex justify-between items-center mb-4">
                        <h4 className="font-bold text-slate-800">Nuova Transazione</h4>
                        {isScanning && <Badge color="black">AI Detected</Badge>}
                    </div>
                    <form onSubmit={handleSubmit} className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
                        <input 
                        required
                        placeholder="Descrizione" 
                        className="p-3 rounded-xl border border-slate-200 focus:ring-2 focus:ring-slate-900 outline-none transition-all"
                        value={formData.description}
                        onChange={e => setFormData({...formData, description: e.target.value})}
                        />
                        <input 
                        required
                        type="number" 
                        placeholder="Importo €" 
                        step="0.01"
                        className="p-3 rounded-xl border border-slate-200 focus:ring-2 focus:ring-slate-900 outline-none transition-all"
                        value={formData.amount}
                        onChange={e => setFormData({...formData, amount: e.target.value})}
                        />
                        <input 
                        required
                        type="date" 
                        className="p-3 rounded-xl border border-slate-200 focus:ring-2 focus:ring-slate-900 outline-none transition-all"
                        value={formData.date}
                        onChange={e => setFormData({...formData, date: e.target.value})}
                        />
                        {type === 'expense' && (
                        <select 
                            className="p-3 rounded-xl border border-slate-200 focus:ring-2 focus:ring-slate-900 outline-none transition-all"
                            value={formData.deductibility}
                            onChange={e => setFormData({...formData, deductibility: e.target.value})}
                        >
                            <option value="100">Deducibile 100%</option>
                            <option value="50">Deducibile 50%</option>
                            <option value="0">Non Deducibile</option>
                        </select>
                        )}
                        <Button type="submit" className="md:col-span-2 lg:col-span-4">Salva</Button>
                    </form>
                    </Card>
                )}

                <div className="bg-white rounded-2xl shadow-sm border border-slate-200 overflow-hidden">
                    <table className="w-full text-left text-sm text-slate-600">
                    <thead className="bg-slate-50 text-slate-500 font-bold uppercase text-[10px] tracking-wider">
                        <tr>
                        <th className="p-4">Data</th>
                        <th className="p-4">Descrizione</th>
                        <th className="p-4">Categoria</th>
                        {type === 'expense' && <th className="p-4">Ded.</th>}
                        <th className="p-4 text-right">Importo</th>
                        <th className="p-4 text-center">Azioni</th>
                        </tr>
                    </thead>
                    <tbody className="divide-y divide-slate-100">
                        {filteredTx.length === 0 ? (
                        <tr><td colSpan={6} className="p-8 text-center text-slate-400 italic">Nessuna transazione registrata.</td></tr>
                        ) : (
                        filteredTx.map(tx => (
                            <tr key={tx.id} className="hover:bg-slate-50/80 transition-colors">
                            <td className="p-4">{new Date(tx.date).toLocaleDateString('it-IT')}</td>
                            <td className="p-4 font-medium text-slate-900">{tx.description}</td>
                            <td className="p-4"><Badge color="slate">{tx.category || 'Generale'}</Badge></td>
                            {type === 'expense' && (
                                <td className="p-4">
                                <div className={`w-2 h-2 rounded-full ${tx.deducibility === 100 ? 'bg-emerald-500' : tx.deducibility === 50 ? 'bg-amber-500' : 'bg-rose-500'}`}></div>
                                </td>
                            )}
                            <td className={`p-4 text-right font-bold ${type === 'income' ? 'text-emerald-600' : 'text-slate-900'}`}>
                                {type === 'expense' ? '-' : '+'} € {formatMoney(tx.amount)}
                            </td>
                            <td className="p-4 text-center">
                                <button 
                                    onClick={() => deleteTx(tx.id)} 
                                    className="flex items-center justify-center w-8 h-8 mx-auto bg-rose-500 text-white rounded-lg hover:bg-rose-700 transition-colors shadow-md"
                                    title="Elimina definitivamente"
                                >
                                    <Icons.Trash2 size={16} />
                                </button>
                            </td>
                            </tr>
                        ))
                        )}
                    </tbody>
                    </table>
                </div>
                </div>
            );
        };

        const Simulator = ({ currentData, settings }) => {
            const [extraRevenue, setExtraRevenue] = useState(10000);
            
            const simulatedData = useTaxCalculator([], settings, currentData.totalRevenue + extraRevenue);
            
            let marginalTaxRate = 0;
            if (settings.regime === 'forfettario') {
                marginalTaxRate = (settings.coefficienteRedditivita / 100) * ((settings.aliquotaInps + settings.impostaSostitutiva) / 100) * 100;
            } else {
                marginalTaxRate = 43; 
            }
            const extraNet = extraRevenue * (1 - marginalTaxRate/100);

            return (
                <div className="space-y-6 animate-in fade-in duration-500">
                <Card className="bg-slate-900 text-white border-none overflow-hidden relative">
                    <div className="absolute top-0 right-0 p-6 opacity-10">
                    <Icons.Calculator size={120} />
                    </div>
                    <div className="relative z-10">
                    <h2 className="text-2xl font-bold mb-2">Simulatore Futuro</h2>
                    <p className="text-slate-400">Proietta il tuo business. Scopri l'impatto fiscale reale.</p>
                    </div>
                </Card>

                <div className="grid grid-cols-1 lg:grid-cols-2 gap-8">
                    <Card>
                    <label className="block text-sm font-bold text-slate-700 mb-6">
                        Se guadagnassi in più:
                    </label>
                    <div className="flex items-center gap-4 mb-4">
                        <span className="text-slate-400 font-mono">€ 0</span>
                        <input 
                            type="range" 
                            min="0" 
                            max="100000" 
                            step="1000" 
                            value={extraRevenue}
                            onChange={(e) => setExtraRevenue(parseInt(e.target.value))}
                            className="w-full h-2 bg-slate-100 rounded-lg appearance-none cursor-pointer accent-slate-900"
                        />
                        <span className="text-slate-400 font-mono">€ 100k</span>
                    </div>
                    <div className="text-center py-4">
                        <span className="text-3xl font-bold text-slate-900">€ {formatMoney(extraRevenue)}</span>
                        <p className="text-xs uppercase tracking-wider text-slate-400 mt-1">Fatturato Extra</p>
                    </div>
                    </Card>

                    <Card className="flex flex-col justify-center items-center text-center bg-emerald-50/50 border-emerald-100">
                    <p className="text-slate-500 font-medium mb-2 text-sm">Ti rimarrebbero in tasca:</p>
                    <h3 className="text-5xl font-bold text-emerald-600">€ {formatMoney(extraNet)}</h3>
                    <div className="mt-4 px-3 py-1 bg-white rounded-full border border-emerald-100 text-xs font-medium text-emerald-800 shadow-sm">
                        Margine Netto: {((extraNet/extraRevenue)*100).toFixed(1)}%
                    </div>
                    </Card>
                </div>
                </div>
            );
        };

        const SettingsPage = ({ settings, setSettings }) => {
            return (
                <div className="space-y-6 max-w-2xl mx-auto animate-in slide-in-from-right duration-500">
                <Card>
                    <h2 className="text-xl font-bold text-slate-900 mb-6 flex items-center gap-2">
                    <Icons.Settings className="text-slate-400" /> Configurazione
                    </h2>
                    <div className="space-y-6">
                    <div>
                        <label className="block text-sm font-bold text-slate-700 mb-3">Regime Fiscale</label>
                        <div className="flex p-1 bg-slate-100 rounded-xl">
                        <button 
                            onClick={() => setSettings({...settings, regime: 'forfettario'})}
                            className={`flex-1 py-3 text-sm font-bold rounded-lg transition-all ${settings.regime === 'forfettario' ? 'bg-white shadow-sm text-slate-900' : 'text-slate-400'}`}
                        >
                            Forfettario
                        </button>
                        <button 
                            onClick={() => setSettings({...settings, regime: 'ordinario'})}
                            className={`flex-1 py-3 text-sm font-bold rounded-lg transition-all ${settings.regime === 'ordinario' ? 'bg-white shadow-sm text-slate-900' : 'text-slate-400'}`}
                        >
                            Ordinario
                        </button>
                        </div>
                    </div>
                    {settings.regime === 'forfettario' && (
                        <div className="grid grid-cols-1 md:grid-cols-2 gap-4 p-5 bg-slate-50 rounded-xl border border-slate-100">
                        <div>
                            <label className="block text-xs font-bold text-slate-500 uppercase mb-1">Coeff. Redditività</label>
                            <input 
                            type="number" 
                            value={settings.coefficienteRedditivita}
                            onChange={(e) => setSettings({...settings, coefficienteRedditivita: parseFloat(e.target.value)})}
                            className="w-full p-2 bg-white rounded-lg border border-slate-200 focus:border-slate-900 outline-none font-mono"
                            />
                        </div>
                        <div>
                            <label className="block text-xs font-bold text-slate-500 uppercase mb-1">Imp. Sostitutiva</label>
                            <select 
                            value={settings.impostaSostitutiva}
                            onChange={(e) => setSettings({...settings, impostaSostitutiva: parseFloat(e.target.value)})}
                            className="w-full p-2 bg-white rounded-lg border border-slate-200 focus:border-slate-900 outline-none font-mono"
                            >
                            <option value="5">5% (Start-up)</option>
                            <option value="15">15% (Standard)</option>
                            </select>
                        </div>
                        </div>
                    )}
                    </div>
                </Card>
                </div>
            );
        };

        const App = () => {
            const [activeTab, setActiveTab] = useState('dashboard');
            const [transactions, setTransactions] = useState(INITIAL_TRANSACTIONS);
            const [settings, setSettings] = useState(INITIAL_SETTINGS);
            const fiscalData = useTaxCalculator(transactions, settings);

            const navItems = [
                { id: 'dashboard', label: 'Home', icon: Icons.LayoutDashboard },
                { id: 'income', label: 'Ricavi', icon: Icons.TrendingUp },
                { id: 'expenses', label: 'Spese', icon: Icons.TrendingDown },
                { id: 'simulator', label: 'Simula', icon: Icons.Calculator },
                { id: 'settings', label: 'Setup', icon: Icons.Settings },
            ];

            return (
                <div className="min-h-screen bg-[#F8F9FC] text-slate-900 font-sans selection:bg-slate-900 selection:text-white">
                {/* Mobile Header */}
                <div className="lg:hidden bg-white p-4 shadow-sm flex justify-between items-center sticky top-0 z-30">
                    <Logo />
                    <button className="p-2 bg-slate-100 rounded-full"><Icons.Settings size={20} /></button>
                </div>

                <div className="flex h-screen overflow-hidden">
                    {/* Sidebar Desktop */}
                    <aside className="hidden lg:flex flex-col w-72 bg-white border-r border-slate-100 h-full shadow-[4px_0_24px_rgba(0,0,0,0.02)] z-20">
                    <div className="p-8 pb-4">
                        <Logo />
                    </div>
                    
                    <nav className="flex-1 px-4 space-y-1 mt-6">
                        {navItems.map((item) => (
                        <button
                            key={item.id}
                            onClick={() => setActiveTab(item.id)}
                            className={`w-full flex items-center justify-between px-4 py-3.5 rounded-xl text-sm font-semibold transition-all group ${
                            activeTab === item.id 
                                ? 'bg-slate-900 text-white shadow-lg shadow-slate-900/20' 
                                : 'text-slate-500 hover:bg-slate-50 hover:text-slate-900'
                            }`}
                        >
                            <div className="flex items-center gap-3">
                            {/* Renderiamo icona componente */}
                            <item.icon size={20} className={activeTab === item.id ? 'text-slate-300' : 'text-slate-400 group-hover:text-slate-600'} />
                            {item.label}
                            </div>
                            {activeTab === item.id && <Icons.ChevronRight size={16} className="text-slate-500" />}
                        </button>
                        ))}
                    </nav>

                    <div className="p-6 mt-auto">
                        <div className="bg-slate-50 p-4 rounded-2xl border border-slate-100">
                            <div className="flex items-center gap-3 mb-3">
                            <div className="p-2 bg-white rounded-lg shadow-sm">
                                <Icons.Briefcase size={18} className="text-slate-900" />
                            </div>
                            <div>
                                <p className="text-[10px] uppercase font-bold text-slate-400">Gruppo</p>
                                <p className="font-bold text-sm text-slate-900">Refisa S.r.l.</p>
                            </div>
                            </div>
                            <div className="text-[10px] text-slate-400 leading-tight">
                            Zero Sorprese è una Business Unit dedicata ai professionisti.
                            </div>
                        </div>
                    </div>
                    </aside>

                    {/* Main Content */}
                    <main className="flex-1 overflow-y-auto relative">
                    <div className="p-6 lg:p-10 max-w-7xl mx-auto pb-32 lg:pb-10">
                        <header className="flex justify-between items-end mb-10 hidden lg:flex">
                            <div>
                            <h1 className="text-3xl font-bold text-slate-900 capitalize tracking-tight">
                                {activeTab === 'dashboard' ? `Bentornato.` : navItems.find(i => i.id === activeTab)?.label}
                            </h1>
                            <p className="text-slate-400 text-sm mt-1 font-medium">
                                {activeTab === 'dashboard' ? 'Il tuo cruscotto finanziario è aggiornato.' : 'Gestione operativa della contabilità.'}
                            </p>
                            </div>
                            <div className="text-right">
                            <div className="flex items-center gap-2 justify-end text-slate-400 text-xs font-bold uppercase mb-1">
                                <span className="w-2 h-2 rounded-full bg-emerald-500 animate-pulse"></span> Live Sync
                            </div>
                            <p className="text-sm text-slate-500 font-medium">{new Date().toLocaleDateString('it-IT', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' })}</p>
                            </div>
                        </header>

                        {activeTab === 'dashboard' && <Dashboard data={fiscalData} settings={settings} />}
                        {activeTab === 'income' && <Transactions transactions={transactions} setTransactions={setTransactions} type="income" />}
                        {activeTab === 'expenses' && <Transactions transactions={transactions} setTransactions={setTransactions} type="expense" />}
                        {activeTab === 'simulator' && <Simulator currentData={fiscalData} settings={settings} />}
                        {activeTab === 'settings' && <SettingsPage settings={settings} setSettings={setSettings} />}
                    </div>
                    </main>

                    {/* Mobile Bottom Nav */}
                    <nav className="lg:hidden fixed bottom-0 left-0 right-0 bg-white/90 backdrop-blur-md border-t border-slate-200 flex justify-around p-4 z-40 safe-area-bottom shadow-2xl">
                        {navItems.map((item) => (
                        <button
                            key={item.id}
                            onClick={() => setActiveTab(item.id)}
                            className={`p-3 rounded-2xl transition-all ${
                            activeTab === item.id 
                                ? 'text-white bg-slate-900 shadow-lg shadow-slate-900/20' 
                                : 'text-slate-400'
                            }`}
                        >
                            <item.icon size={24} />
                        </button>
                        ))}
                    </nav>
                </div>
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>

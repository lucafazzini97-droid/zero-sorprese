<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Zero Sorprese - Cruscotto Fiscale</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    
    <script src="https://unpkg.com/prop-types/prop-types.min.js"></script>

    <script src="https://unpkg.com/recharts@2.12.0/umd/Recharts.js"></script>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    
    <script src="https://unpkg.com/lucide@0.263.1/dist/umd/lucide.min.js"></script>
    
    <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
    
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;900&display=swap');
        body { font-family: 'Inter', sans-serif; -webkit-tap-highlight-color: transparent; }
        
        /* Utility Scrollbar */
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        
        /* Animation Utilities */
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .animate-fade-in { animation: fadeIn 0.5s ease-out forwards; }
    </style>

    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: { sans: ['Inter', 'sans-serif'] },
                    colors: {
                        slate: { 850: '#1e293b', 950: '#020617' }
                    }
                }
            }
        }
    </script>
</head>
<body class="bg-[#F8F9FC] text-slate-900 antialiased selection:bg-slate-900 selection:text-white">

    <div id="root"></div>

    <script type="text/babel">
        const { useState, useMemo, useEffect, useRef, useCallback } = React;

        // --- SAFE LIBRARY ACCESS ---
        // Accesso sicuro alle librerie globali per evitare crash se non sono ancora caricate
        const Recharts = window.Recharts || {};
        const { PieChart, Pie, Cell, BarChart, Bar, XAxis, YAxis, CartesianGrid, Tooltip: RechartsTooltip, ResponsiveContainer } = Recharts;

        // --- HELPER FUNCTIONS ---

        const formatMoney = (amount) => {
            if (amount === undefined || amount === null) return "0,00";
            return Number(amount).toLocaleString('it-IT', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
        };

        const parseItalianNumber = (value) => {
            if (!value && value !== 0) return 0;
            if (typeof value === 'number') return value;
            // Rimuove tutto tranne numeri, virgole, punti e segno meno
            const cleaned = String(value).replace(/[^\d.,-]/g, '');
            // Rimuove i punti delle migliaia e cambia la virgola in punto
            const normalized = cleaned.replace(/\./g, '').replace(',', '.');
            const num = parseFloat(normalized);
            return isNaN(num) ? 0 : num;
        };

        // --- COMPONENTS ---

        // 1. Icon Component (Robust Version)
        const Icon = ({ name, size = 24, className, ...props }) => {
            // Fallback sicuro se Lucide non è caricato o l'icona non esiste
            if (!window.lucide || !window.lucide.icons || !window.lucide.icons[name]) {
                // Ritorna un placeholder o null per evitare crash
                return <span style={{width: size, height: size, display: 'inline-block'}}></span>;
            }
            
            const iconData = window.lucide.icons[name];
            const [tag, attrs, children] = iconData;
            
            return (
                <svg
                    {...attrs}
                    width={size}
                    height={size}
                    className={className}
                    {...props}
                    dangerouslySetInnerHTML={{
                        __html: children.map(([childTag, childAttrs]) => {
                            const attrString = Object.entries(childAttrs).map(([k, v]) => `${k}="${v}"`).join(' ');
                            return `<${childTag} ${attrString} />`;
                        }).join('')
                    }}
                />
            );
        };

        const Icons = {
            LayoutDashboard: (p) => <Icon name="LayoutDashboard" {...p} />,
            TrendingUp: (p) => <Icon name="TrendingUp" {...p} />,
            TrendingDown: (p) => <Icon name="TrendingDown" {...p} />,
            Calculator: (p) => <Icon name="Calculator" {...p} />,
            Settings: (p) => <Icon name="Settings" {...p} />,
            Plus: (p) => <Icon name="Plus" {...p} />,
            Trash2: (p) => <Icon name="Trash2" {...p} />,
            AlertCircle: (p) => <Icon name="AlertCircle" {...p} />,
            Building2: (p) => <Icon name="Building2" {...p} />,
            Calendar: (p) => <Icon name="Calendar" {...p} />,
            Download: (p) => <Icon name="Download" {...p} />,
            ScanLine: (p) => <Icon name="ScanLine" {...p} />,
            FileUp: (p) => <Icon name="FileUp" {...p} />,
            Briefcase: (p) => <Icon name="Briefcase" {...p} />,
            ChevronRight: (p) => <Icon name="ChevronRight" {...p} />,
            Check: (p) => <Icon name="Check" {...p} />,
            User: (p) => <Icon name="User" {...p} />,
            Lock: (p) => <Icon name="Lock" {...p} />,
            ArrowRight: (p) => <Icon name="ArrowRight" {...p} />,
            LogOut: (p) => <Icon name="LogOut" {...p} />,
        };

        // 2. UI Base Components
        const Card = ({ children, className = '', noPadding = false }) => (
            <div className={`bg-white rounded-2xl shadow-sm border border-slate-100 ${noPadding ? '' : 'p-6'} ${className}`}>
                {children}
            </div>
        );

        const Badge = ({ children, color = 'slate' }) => {
            const colors = {
                slate: 'bg-slate-100 text-slate-700',
                green: 'bg-emerald-50 text-emerald-700 border border-emerald-100',
                red: 'bg-rose-50 text-rose-700 border border-rose-100',
                yellow: 'bg-amber-50 text-amber-700 border border-amber-100',
                black: 'bg-slate-900 text-white'
            };
            return (
                <span className={`px-2.5 py-0.5 rounded-full text-[11px] font-bold uppercase tracking-wide ${colors[color] || colors.slate}`}>
                    {children}
                </span>
            );
        };

        const Button = ({ children, onClick, variant = 'primary', icon: IconComp, className = '', disabled = false }) => {
            const baseStyle = "flex items-center justify-center gap-2 px-4 py-2.5 rounded-xl font-medium text-sm transition-all duration-200 disabled:opacity-50 disabled:cursor-not-allowed active:scale-[0.98]";
            const variants = {
                primary: "bg-slate-900 text-white hover:bg-slate-800 shadow-md shadow-slate-900/10",
                secondary: "bg-white text-slate-700 border border-slate-200 hover:bg-slate-50 hover:border-slate-300",
                danger: "bg-white text-rose-600 hover:bg-rose-50 border border-rose-100",
                ghost: "text-slate-500 hover:text-slate-900 hover:bg-slate-100",
            };
            
            return (
                <button onClick={onClick} disabled={disabled} className={`${baseStyle} ${variants[variant]} ${className}`}>
                    {IconComp && <IconComp size={16} />}
                    {children}
                </button>
            );
        };

        // 3. Logic Hooks
        const useTaxCalculator = (transactions, settings, simulatedRevenueAdd = 0) => {
            return useMemo(() => {
                const incomes = transactions.filter(t => t.type === 'income');
                const expenses = transactions.filter(t => t.type === 'expense');

                const totalRevenue = incomes.reduce((acc, curr) => acc + curr.amount, 0) + simulatedRevenueAdd;
                const totalExpensesReal = expenses.reduce((acc, curr) => acc + curr.amount, 0);
                
                let taxableIncome = 0;
                let taxes = 0;
                let inps = 0;
                let totalDeductibleExpenses = 0;

                if (settings.regime === 'forfettario') {
                    // Calcolo Forfettario
                    taxableIncome = totalRevenue * (settings.coefficienteRedditivita / 100);
                    inps = taxableIncome * (settings.aliquotaInps / 100);
                    // L'INPS è deducibile dall'imponibile fiscale nel forfettario
                    const imponibileNettoInps = Math.max(0, taxableIncome - inps); 
                    taxes = imponibileNettoInps * (settings.impostaSostitutiva / 100);
                } else {
                    // Calcolo Ordinario (Semplificato)
                    totalDeductibleExpenses = expenses.reduce((acc, curr) => {
                        const deducibility = curr.deductibility !== undefined ? curr.deductibility : 100;
                        return acc + (curr.amount * (deducibility / 100));
                    }, 0);
                    
                    // Imponibile = Ricavi - Spese Deducibili
                    taxableIncome = Math.max(0, totalRevenue - totalDeductibleExpenses);
                    
                    // INPS (Gestione Separata o Artigiani/Comm è complesso, qui approssimiamo alla gestione separata su tutto l'imponibile)
                    inps = taxableIncome * (settings.aliquotaInps / 100);
                    
                    // Imponibile IRPEF = Imponibile - INPS
                    const incomeAfterInps = Math.max(0, taxableIncome - inps);

                    // Calcolo Scaglioni IRPEF
                    let remainingIncome = incomeAfterInps;
                    let calculatedIrpef = 0;
                    let previousLimit = 0;

                    for (let bracket of settings.scaglioniIrpef) {
                        if (remainingIncome <= 0) break;
                        const limit = bracket.limit === Infinity ? Number.MAX_VALUE : bracket.limit;
                        const taxableInThisBracket = Math.min(remainingIncome, limit - previousLimit);
                        
                        if (taxableInThisBracket > 0) {
                            calculatedIrpef += taxableInThisBracket * (bracket.rate / 100);
                            remainingIncome -= taxableInThisBracket;
                            previousLimit = limit;
                        }
                    }
                    taxes = calculatedIrpef;
                }

                const totalTaxLoad = taxes + inps;
                const netIncome = totalRevenue - totalExpensesReal - totalTaxLoad;

                return {
                    totalRevenue,
                    totalExpensesReal,
                    totalDeductibleExpenses,
                    taxableIncome,
                    inps,
                    taxes,
                    totalTaxLoad,
                    netIncome
                };
            }, [transactions, settings, simulatedRevenueAdd]);
        };

        // --- PDF GENERATOR (Scoped) ---
        const generatePdfReport = (data, settings) => {
            if (!window.jspdf || !window.jspdf.jsPDF) {
                alert("Libreria PDF non caricata correttamente.");
                return;
            }
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            const pageWidth = doc.internal.pageSize.getWidth();
            const year = new Date().getFullYear();

            // Header Scuro
            doc.setFillColor(2, 6, 23); // Slate 950
            doc.rect(0, 0, pageWidth, 40, "F");
            
            doc.setTextColor(255, 255, 255);
            doc.setFontSize(22);
            doc.setFont("helvetica", "bold");
            doc.text("Zero Sorprese", 14, 20);
            
            doc.setFontSize(10);
            doc.setFont("helvetica", "normal");
            doc.text("BU of REFISA - Cruscotto Fiscale", 14, 28);
            
            doc.text(`Report ${year}`, pageWidth - 14, 20, { align: "right" });
            doc.text(`Generato il ${new Date().toLocaleDateString()}`, pageWidth - 14, 28, { align: "right" });

            let y = 55;

            // Sezione 1: Sintesi
            doc.setTextColor(15, 23, 42);
            doc.setFontSize(14);
            doc.setFont("helvetica", "bold");
            doc.text("Sintesi Economica", 14, y);
            y += 10;

            const row = (label, value, isBold = false) => {
                doc.setFont("helvetica", isBold ? "bold" : "normal");
                doc.setFontSize(12);
                doc.text(label, 14, y);
                doc.text(`€ ${formatMoney(value)}`, pageWidth - 14, y, { align: "right" });
                y += 8;
            };

            row("Fatturato Totale", data.totalRevenue);
            row("Spese Totali", data.totalExpensesReal);
            y += 2;
            doc.setDrawColor(200);
            doc.line(14, y, pageWidth - 14, y);
            y += 8;
            
            doc.setTextColor(220, 38, 38); // Red
            row("Stima Tasse (IRPEF/Sostitutiva)", data.taxes);
            row("Stima INPS", data.inps);
            doc.setTextColor(15, 23, 42); // Reset

            y += 4;
            // Box Netto
            doc.setFillColor(240, 253, 244); // Emerald 50
            doc.roundedRect(14, y, pageWidth - 28, 20, 2, 2, "F");
            doc.setDrawColor(22, 163, 74);
            doc.rect(14, y, pageWidth - 28, 20, "S");
            
            y += 13;
            doc.setTextColor(22, 101, 52);
            doc.setFont("helvetica", "bold");
            doc.setFontSize(16);
            doc.text("DISPONIBILE REALE", 20, y);
            doc.text(`€ ${formatMoney(data.netIncome)}`, pageWidth - 20, y, { align: "right" });

            // Footer
            doc.setFontSize(8);
            doc.setTextColor(100);
            doc.text("Nota: Questo documento è una simulazione e non ha valore legale.", 14, 280);

            doc.save(`zero_sorprese_report_${year}.pdf`);
        };

        // --- SUB-COMPONENTS ---

        const SmartAlert = ({ revenue, limit = 85000, regime }) => {
            if (regime !== 'forfettario') return null;
            const remaining = limit - revenue;
            const percentage = (revenue / limit) * 100;
            const isCritical = remaining < 5000;
            const isWarning = percentage > 80;

            return (
                <Card className={`border-l-4 ${isCritical ? 'border-l-rose-500' : isWarning ? 'border-l-amber-500' : 'border-l-emerald-500'}`}>
                    <div className="flex justify-between items-start mb-2">
                        <div>
                            <h4 className="font-bold text-slate-800 text-sm">Plafond Forfettario</h4>
                            <p className="text-xs text-slate-500">Limite 85k annui</p>
                        </div>
                        <Badge color={isCritical ? 'red' : isWarning ? 'yellow' : 'green'}>
                            {percentage.toFixed(1)}% Usato
                        </Badge>
                    </div>
                    <div className="w-full bg-slate-100 rounded-full h-2.5 mt-2 overflow-hidden">
                        <div 
                            className={`h-2.5 rounded-full transition-all duration-1000 ${isCritical ? 'bg-rose-500' : isWarning ? 'bg-amber-500' : 'bg-emerald-500'}`} 
                            style={{ width: `${Math.min(percentage, 100)}%` }}
                        ></div>
                    </div>
                    <div className="mt-2 text-right text-xs font-mono font-medium text-slate-600">
                        Rimangono € {formatMoney(remaining)}
                    </div>
                </Card>
            );
        };

        const Logo = ({ light = false }) => (
            <div className={`flex flex-col select-none ${light ? 'text-white' : 'text-slate-900'}`}>
                <div className="font-black text-2xl tracking-tighter flex items-center gap-1 leading-none">
                    <span>ZERO</span>
                    <span className="font-light">SORPRESE</span>
                </div>
                <div className={`text-[10px] font-medium tracking-widest uppercase mt-1 flex items-center gap-1 ${light ? 'text-slate-400' : 'text-slate-400'}`}>
                    <span className="w-2 h-[1px] bg-current"></span>
                    BU of REFISA
                </div>
            </div>
        );

        // --- PAGES ---

        const Auth = ({ onLogin }) => {
            const [isLoading, setIsLoading] = useState(false);
            const [email, setEmail] = useState("demo@zerosorprese.it");
            
            const handleLogin = (e) => {
                e.preventDefault();
                setIsLoading(true);
                // Simulazione ritardo network
                setTimeout(() => {
                    setIsLoading(false);
                    onLogin({ name: "Mario Rossi", email: email });
                }, 800);
            };

            return (
                <div className="min-h-screen flex items-center justify-center bg-white p-4">
                    <div className="w-full max-w-md animate-fade-in">
                        <div className="text-center mb-10">
                            <div className="inline-block mb-4"><Logo /></div>
                            <h2 className="text-2xl font-bold text-slate-900">Bentornato</h2>
                            <p className="text-slate-500">Accedi al tuo cruscotto fiscale</p>
                        </div>
                        
                        <form onSubmit={handleLogin} className="space-y-4">
                            <div>
                                <label className="block text-xs font-bold text-slate-700 uppercase mb-2">Email</label>
                                <input 
                                    type="email" 
                                    required
                                    value={email}
                                    onChange={e => setEmail(e.target.value)}
                                    className="w-full p-4 bg-slate-50 border border-slate-200 rounded-xl focus:ring-2 focus:ring-slate-900 outline-none transition-all"
                                    placeholder="name@company.com"
                                />
                            </div>
                            <div>
                                <label className="block text-xs font-bold text-slate-700 uppercase mb-2">Password</label>
                                <input 
                                    type="password" 
                                    defaultValue="password"
                                    className="w-full p-4 bg-slate-50 border border-slate-200 rounded-xl focus:ring-2 focus:ring-slate-900 outline-none transition-all"
                                    placeholder="••••••••"
                                />
                            </div>
                            <button 
                                type="submit" 
                                disabled={isLoading}
                                className="w-full bg-slate-900 text-white font-bold py-4 rounded-xl hover:bg-slate-800 transition-all disabled:opacity-70 flex items-center justify-center gap-2"
                            >
                                {isLoading ? "Accesso in corso..." : "Accedi"}
                                {!isLoading && <Icons.ArrowRight size={18} />}
                            </button>
                        </form>
                        <p className="text-center text-xs text-slate-400 mt-8">
                            Refisa S.r.l. &copy; {new Date().getFullYear()}
                        </p>
                    </div>
                </div>
            );
        };

        const Dashboard = ({ data, settings }) => {
            const chartData = [
                { name: "Netto", value: data.netIncome, color: "#10B981" },
                { name: "Tasse", value: data.taxes, color: "#F43F5E" },
                { name: "INPS", value: data.inps, color: "#F59E0B" },
                { name: "Spese", value: data.totalExpensesReal, color: "#94A3B8" },
            ];

            return (
                <div className="space-y-6 animate-fade-in pb-20">
                    <SmartAlert revenue={data.totalRevenue} regime={settings.regime} />
                    
                    {/* KPI Cards */}
                    <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
                        <Card>
                            <div className="text-slate-500 text-xs font-bold uppercase tracking-wider mb-1 flex items-center gap-2">
                                <Icons.TrendingUp size={14} className="text-emerald-500"/> Fatturato
                            </div>
                            <div className="text-2xl font-bold text-slate-900">€ {formatMoney(data.totalRevenue)}</div>
                        </Card>
                        <Card>
                             <div className="text-slate-500 text-xs font-bold uppercase tracking-wider mb-1 flex items-center gap-2">
                                <Icons.AlertCircle size={14} className="text-rose-500"/> Tasse Stimate
                            </div>
                            <div className="text-2xl font-bold text-rose-600">€ {formatMoney(data.totalTaxLoad)}</div>
                            <div className="text-[10px] text-rose-400 mt-1">Accantona subito</div>
                        </Card>
                         <Card className="bg-slate-900 text-white border-slate-800">
                             <div className="text-slate-400 text-xs font-bold uppercase tracking-wider mb-1 flex items-center gap-2">
                                <Icons.Briefcase size={14} className="text-emerald-400"/> Netto Reale
                            </div>
                            <div className="text-2xl font-bold text-white">€ {formatMoney(data.netIncome)}</div>
                            <div className="text-[10px] text-emerald-400 mt-1">Safe to spend</div>
                        </Card>
                        <Card className="flex flex-col justify-center">
                            <Button variant="secondary" onClick={() => generatePdfReport(data, settings)} icon={Icons.Download}>
                                Scarica Report PDF
                            </Button>
                        </Card>
                    </div>

                    {/* Chart & Analysis */}
                    <div className="grid grid-cols-1 lg:grid-cols-3 gap-6">
                        <Card className="lg:col-span-2 h-80">
                            <h4 className="font-bold text-slate-800 mb-4">Analisi Flusso</h4>
                            <div className="h-60 w-full">
                                {window.Recharts ? (
                                    <ResponsiveContainer width="100%" height="100%">
                                        <BarChart data={chartData} layout="vertical" margin={{left: 40}}>
                                            <CartesianGrid strokeDasharray="3 3" horizontal={false} stroke="#f1f5f9" />
                                            <XAxis type="number" hide />
                                            <YAxis dataKey="name" type="category" width={60} tick={{fontSize:12}} axisLine={false} tickLine={false} />
                                            <RechartsTooltip 
                                                cursor={{fill: '#f8fafc'}}
                                                contentStyle={{borderRadius: '12px', border:'none', boxShadow:'0 10px 15px -3px rgba(0,0,0,0.1)'}}
                                                formatter={(val) => `€ ${formatMoney(val)}`}
                                            />
                                            <Bar dataKey="value" radius={[0,6,6,0]} barSize={30}>
                                                {chartData.map((entry, index) => (
                                                    <Cell key={`cell-${index}`} fill={entry.color} />
                                                ))}
                                            </Bar>
                                        </BarChart>
                                    </ResponsiveContainer>
                                ) : (
                                    <div className="h-full w-full flex items-center justify-center text-slate-400 bg-slate-50 rounded-xl">
                                        Caricamento Grafico...
                                    </div>
                                )}
                            </div>
                        </Card>

                        <div className="space-y-6">
                            <Card>
                                <h4 className="font-bold text-slate-800 mb-4">Peso Fiscale</h4>
                                <div className="flex items-center justify-center h-40 relative">
                                    <div className="text-center absolute">
                                        <span className="block text-3xl font-black text-slate-900">
                                            {data.totalRevenue > 0 ? Math.round((data.totalTaxLoad / data.totalRevenue) * 100) : 0}%
                                        </span>
                                        <span className="text-[10px] text-slate-500 uppercase tracking-widest">Tax Rate</span>
                                    </div>
                                    {window.Recharts && (
                                        <ResponsiveContainer width="100%" height="100%">
                                            <PieChart>
                                                <Pie
                                                    data={[
                                                        { value: data.totalTaxLoad, color: '#F43F5E' }, // Tasse
                                                        { value: data.netIncome + data.totalExpensesReal, color: '#f1f5f9' } // Resto
                                                    ]}
                                                    innerRadius={60}
                                                    outerRadius={75}
                                                    dataKey="value"
                                                    stroke="none"
                                                    startAngle={90}
                                                    endAngle={-270}
                                                >
                                                    <Cell fill="#F43F5E" />
                                                    <Cell fill="#f1f5f9" />
                                                </Pie>
                                            </PieChart>
                                        </ResponsiveContainer>
                                    )}
                                </div>
                            </Card>
                            
                            <div className="bg-emerald-50 border border-emerald-100 p-4 rounded-2xl flex gap-3">
                                <div className="bg-white p-2 rounded-lg h-fit text-emerald-600 shadow-sm">
                                    <Icons.Briefcase size={20} />
                                </div>
                                <div>
                                    <h5 className="font-bold text-emerald-900 text-sm">Consiglio di Refisa</h5>
                                    <p className="text-xs text-emerald-700 mt-1 leading-relaxed">
                                        Con un margine del {data.totalRevenue > 0 ? Math.round((data.netIncome / data.totalRevenue)*100) : 0}%, 
                                        puoi considerare investimenti deducibili entro fine anno.
                                    </p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            );
        };

        const Transactions = ({ transactions, setTransactions, type }) => {
            const [isAdding, setIsAdding] = useState(false);
            const [formData, setFormData] = useState({
                description: '', amount: '', date: new Date().toISOString().split('T')[0], category: 'Generale', deductibility: 100
            });
            const fileInputRef = useRef(null);

            const handleImportCSV = (e) => {
                const file = e.target.files && e.target.files[0];
                if (!file) return;

                if (!window.Papa) {
                    alert("Motore CSV non pronto. Riprova tra un secondo.");
                    return;
                }

                window.Papa.parse(file, {
                    header: true,
                    skipEmptyLines: true,
                    complete: (results) => {
                        const newTx = [];
                        results.data.forEach((row, idx) => {
                            // Logica adattiva per colonne comuni TeamSystem
                            const desc = row['Descrizione'] || row['Causale'] || 'Import CSV';
                            const valStr = row['Saldo'] || row['Importo'] || row['Dare'] || '0';
                            const val = parseItalianNumber(valStr);
                            
                            // Determina se è entrata o uscita in base al tipo richiesto e al segno
                            // Qui semplifichiamo: se siamo in "Ricavi", importiamo tutto come positivo
                            if (val !== 0) {
                                newTx.push({
                                    id: Date.now() + idx,
                                    type: type,
                                    date: new Date().toISOString().split('T')[0], // Default a oggi se manca data
                                    description: desc,
                                    amount: Math.abs(val),
                                    category: 'Import',
                                    deductibility: 100
                                });
                            }
                        });
                        setTransactions(prev => [...prev, ...newTx]);
                        alert(`Importate ${newTx.length} transazioni.`);
                    }
                });
                e.target.value = ''; // Reset input
            };

            const handleSubmit = (e) => {
                e.preventDefault();
                setTransactions(prev => [...prev, {
                    id: Date.now(),
                    type,
                    description: formData.description,
                    amount: parseFloat(formData.amount),
                    date: formData.date,
                    category: formData.category,
                    deductibility: parseInt(formData.deductibility)
                }]);
                setIsAdding(false);
                setFormData({ description: '', amount: '', date: new Date().toISOString().split('T')[0], category: 'Generale', deductibility: 100 });
            };

            const filtered = transactions.filter(t => t.type === type).sort((a,b) => new Date(b.date) - new Date(a.date));

            return (
                <div className="pb-20 animate-fade-in">
                    <div className="flex justify-between items-center mb-6">
                        <h2 className="text-xl font-bold text-slate-900">Gestione {type === 'income' ? 'Ricavi' : 'Spese'}</h2>
                        <div className="flex gap-2">
                            <input type="file" ref={fileInputRef} onChange={handleImportCSV} accept=".csv" className="hidden" />
                            <Button variant="secondary" onClick={() => fileInputRef.current.click()} icon={Icons.FileUp} className="hidden sm:flex">
                                Importa CSV
                            </Button>
                            <Button onClick={() => setIsAdding(!isAdding)} icon={Icons.Plus}>
                                Nuova
                            </Button>
                        </div>
                    </div>

                    {isAdding && (
                        <Card className="mb-6 bg-slate-50 border-slate-200">
                            <form onSubmit={handleSubmit} className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-5 gap-4">
                                <input required type="date" className="p-3 rounded-xl border" value={formData.date} onChange={e => setFormData({...formData, date: e.target.value})} />
                                <input required placeholder="Descrizione" className="p-3 rounded-xl border md:col-span-2" value={formData.description} onChange={e => setFormData({...formData, description: e.target.value})} />
                                <input required type="number" step="0.01" placeholder="€ Importo" className="p-3 rounded-xl border" value={formData.amount} onChange={e => setFormData({...formData, amount: e.target.value})} />
                                <Button type="submit" variant="primary">Salva</Button>
                            </form>
                        </Card>
                    )}

                    <div className="bg-white rounded-2xl border border-slate-100 overflow-hidden shadow-sm">
                        <table className="w-full text-left text-sm">
                            <thead className="bg-slate-50 text-slate-500 font-bold uppercase text-[10px] tracking-wider">
                                <tr>
                                    <th className="p-4">Data</th>
                                    <th className="p-4">Descrizione</th>
                                    <th className="p-4 text-right">Importo</th>
                                    <th className="p-4 w-10"></th>
                                </tr>
                            </thead>
                            <tbody className="divide-y divide-slate-100">
                                {filtered.length === 0 ? (
                                    <tr><td colSpan="4" className="p-8 text-center text-slate-400">Nessuna transazione.</td></tr>
                                ) : (
                                    filtered.map(tx => (
                                        <tr key={tx.id} className="hover:bg-slate-50/50">
                                            <td className="p-4 whitespace-nowrap text-slate-500">{new Date(tx.date).toLocaleDateString('it-IT')}</td>
                                            <td className="p-4 font-medium text-slate-900">{tx.description}</td>
                                            <td className={`p-4 text-right font-bold ${type === 'income' ? 'text-emerald-600' : 'text-slate-900'}`}>
                                                {type === 'expense' ? '-' : '+'} € {formatMoney(tx.amount)}
                                            </td>
                                            <td className="p-4 text-right">
                                                <button onClick={() => setTransactions(prev => prev.filter(t => t.id !== tx.id))} className="text-slate-300 hover:text-rose-500 transition-colors">
                                                    <Icons.Trash2 size={16} />
                                                </button>
                                            </td>
                                        </tr>
                                    ))
                                )}
                            </tbody>
                        </table>
                    </div>
                </div>
            );
        };

        const SettingsPage = ({ settings, setSettings }) => (
            <div className="max-w-xl mx-auto pb-20 animate-fade-in">
                <Card>
                    <h3 className="font-bold text-lg mb-6 flex items-center gap-2">
                        <Icons.Settings className="text-slate-400"/> Configurazione Fiscale
                    </h3>
                    
                    <div className="space-y-6">
                        <div>
                            <label className="block text-xs font-bold uppercase text-slate-500 mb-2">Regime</label>
                            <div className="flex bg-slate-100 p-1 rounded-xl">
                                {['forfettario', 'ordinario'].map(r => (
                                    <button 
                                        key={r}
                                        onClick={() => setSettings({...settings, regime: r})}
                                        className={`flex-1 py-2.5 rounded-lg text-sm font-bold capitalize transition-all ${settings.regime === r ? 'bg-white shadow-sm text-slate-900' : 'text-slate-400'}`}
                                    >
                                        {r}
                                    </button>
                                ))}
                            </div>
                        </div>

                        {settings.regime === 'forfettario' && (
                            <div className="grid grid-cols-2 gap-4">
                                <div>
                                    <label className="block text-xs font-bold uppercase text-slate-500 mb-2">Coeff. Redditività %</label>
                                    <input 
                                        type="number" 
                                        value={settings.coefficienteRedditivita}
                                        onChange={e => setSettings({...settings, coefficienteRedditivita: parseFloat(e.target.value)})}
                                        className="w-full p-3 border rounded-xl"
                                    />
                                </div>
                                <div>
                                    <label className="block text-xs font-bold uppercase text-slate-500 mb-2">Imp. Sostitutiva %</label>
                                    <select 
                                        value={settings.impostaSostitutiva}
                                        onChange={e => setSettings({...settings, impostaSostitutiva: parseFloat(e.target.value)})}
                                        className="w-full p-3 border rounded-xl bg-white"
                                    >
                                        <option value="5">5% (Start-up)</option>
                                        <option value="15">15% (Standard)</option>
                                    </select>
                                </div>
                            </div>
                        )}
                        
                        <div>
                            <label className="block text-xs font-bold uppercase text-slate-500 mb-2">Aliquota INPS %</label>
                            <input 
                                type="number" step="0.01"
                                value={settings.aliquotaInps}
                                onChange={e => setSettings({...settings, aliquotaInps: parseFloat(e.target.value)})}
                                className="w-full p-3 border rounded-xl"
                            />
                        </div>
                    </div>
                </Card>
            </div>
        );

        // --- MAIN APP ---

        const INITIAL_DATA = [
            { id: 1, type: 'income', date: '2024-01-15', description: 'Consulenza Web', amount: 2500 },
            { id: 2, type: 'expense', date: '2024-01-20', description: 'Abbonamento Software', amount: 50, deductibility: 100 },
        ];

        const INITIAL_SETTINGS = {
            regime: 'forfettario', 
            coefficienteRedditivita: 78,
            impostaSostitutiva: 5,
            aliquotaInps: 26.23,
            scaglioniIrpef: [{ limit: 28000, rate: 23 }, { limit: 50000, rate: 35 }, { limit: Infinity, rate: 43 }]
        };

        const App = () => {
            // Inizializzazione Lazy dello stato per leggere il LocalStorage solo una volta all'avvio
            const [user, setUser] = useState(() => {
                const saved = localStorage.getItem('zs_user');
                return saved ? JSON.parse(saved) : null;
            });

            const [transactions, setTransactions] = useState(() => {
                const saved = localStorage.getItem('zs_transactions');
                return saved ? JSON.parse(saved) : INITIAL_DATA;
            });

            const [settings, setSettings] = useState(() => {
                const saved = localStorage.getItem('zs_settings');
                return saved ? JSON.parse(saved) : INITIAL_SETTINGS;
            });

            const [activeTab, setActiveTab] = useState('dashboard');

            // Salvataggio automatico nei LocalStorage quando cambiano gli stati
            useEffect(() => {
                if (user) localStorage.setItem('zs_user', JSON.stringify(user));
                else localStorage.removeItem('zs_user');
            }, [user]);

            useEffect(() => {
                localStorage.setItem('zs_transactions', JSON.stringify(transactions));
            }, [transactions]);

            useEffect(() => {
                localStorage.setItem('zs_settings', JSON.stringify(settings));
            }, [settings]);

            const fiscalData = useTaxCalculator(transactions, settings);

            const handleLogout = () => {
                setUser(null);
                setActiveTab('dashboard');
            };

            if (!user) return <Auth onLogin={setUser} />;

            const NavItem = ({ id, label, icon: IconComp }) => (
                <button 
                    onClick={() => setActiveTab(id)}
                    className={`flex-1 flex flex-col items-center justify-center py-2 transition-colors ${activeTab === id ? 'text-slate-900' : 'text-slate-400 hover:text-slate-600'}`}
                >
                    <IconComp size={24} strokeWidth={activeTab === id ? 2.5 : 2} />
                    <span className="text-[10px] font-medium mt-1">{label}</span>
                </button>
            );

            return (
                <div className="flex h-screen bg-[#F8F9FC] overflow-hidden">
                    {/* Sidebar Desktop */}
                    <aside className="hidden md:flex flex-col w-64 bg-white border-r border-slate-200 h-full p-6">
                        <div className="mb-10"><Logo /></div>
                        <nav className="flex-1 space-y-2">
                            {[
                                { id: 'dashboard', label: 'Dashboard', icon: Icons.LayoutDashboard },
                                { id: 'income', label: 'Ricavi', icon: Icons.TrendingUp },
                                { id: 'expense', label: 'Spese', icon: Icons.TrendingDown },
                                { id: 'settings', label: 'Configurazione', icon: Icons.Settings },
                            ].map(item => (
                                <button
                                    key={item.id}
                                    onClick={() => setActiveTab(item.id)}
                                    className={`w-full flex items-center gap-3 px-4 py-3 rounded-xl font-medium transition-all ${
                                        activeTab === item.id ? 'bg-slate-900 text-white shadow-md' : 'text-slate-500 hover:bg-slate-50'
                                    }`}
                                >
                                    <item.icon size={20} />
                                    {item.label}
                                </button>
                            ))}
                        </nav>
                        <div className="pt-6 border-t border-slate-100">
                            <div className="flex items-center gap-3 mb-4">
                                <div className="w-8 h-8 rounded-full bg-slate-100 flex items-center justify-center text-slate-600 font-bold">
                                    {user.name.charAt(0)}
                                </div>
                                <div className="flex-1 overflow-hidden">
                                    <p className="text-sm font-bold text-slate-900 truncate">{user.name}</p>
                                    <p className="text-xs text-slate-400 truncate">{user.email}</p>
                                </div>
                            </div>
                            <Button variant="secondary" onClick={handleLogout} className="w-full text-xs" icon={Icons.LogOut}>Esci</Button>
                        </div>
                    </aside>

                    {/* Main Content */}
                    <main className="flex-1 flex flex-col h-full overflow-hidden relative">
                        {/* Header Mobile */}
                        <header className="md:hidden bg-white border-b border-slate-200 p-4 flex justify-between items-center z-20">
                            <Logo />
                            <button onClick={handleLogout} className="text-slate-400"><Icons.LogOut size={20}/></button>
                        </header>

                        <div className="flex-1 overflow-y-auto p-4 lg:p-10 scroll-smooth pb-32 md:pb-10">
                            <div className="max-w-5xl mx-auto">
                                <header className="mb-8 hidden md:block">
                                    <h1 className="text-2xl font-bold text-slate-900">
                                        {activeTab === 'dashboard' ? `Ciao, ${user.name}` : 
                                         activeTab === 'income' ? 'Registra Ricavi' :
                                         activeTab === 'expense' ? 'Registra Spese' : 'Impostazioni'}
                                    </h1>
                                    <p className="text-slate-500 text-sm">Panoramica finanziaria aggiornata ad oggi.</p>
                                </header>

                                {activeTab === 'dashboard' && <Dashboard data={fiscalData} settings={settings} />}
                                {activeTab === 'income' && <Transactions transactions={transactions} setTransactions={setTransactions} type="income" />}
                                {activeTab === 'expense' && <Transactions transactions={transactions} setTransactions={setTransactions} type="expense" />}
                                {activeTab === 'settings' && <SettingsPage settings={settings} setSettings={setSettings} />}
                            </div>
                        </div>

                        {/* Mobile Bottom Nav - SAFE AREA FIX */}
                        <nav className="md:hidden fixed bottom-0 left-0 right-0 bg-white border-t border-slate-200 pb-safe z-50 flex justify-around px-2 py-2 shadow-[0_-4px_20px_rgba(0,0,0,0.05)]">
                            <NavItem id="dashboard" label="Home" icon={Icons.LayoutDashboard} />
                            <NavItem id="income" label="Ricavi" icon={Icons.TrendingUp} />
                            <NavItem id="expense" label="Spese" icon={Icons.TrendingDown} />
                            <NavItem id="settings" label="Setup" icon={Icons.Settings} />
                        </nav>
                    </main>
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
